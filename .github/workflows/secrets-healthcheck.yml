name: Secrets Health Check
on:
  schedule:
    - cron: '0 9 * * 1'
  workflow_dispatch:
env:
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
  NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
jobs:
  check-expirations:
    runs-on: ubuntu-latest
    steps:
      - name: Decode and check JWT expirations
        shell: bash
        run: |
          check_token() {
            local name="$1" token="$2" threshold_days="$3"
            if [ -z "$token" ]; then
              echo "::warning title=$name missing::Secret $name is not set"
              return
            fi
            IFS='.' read -r header payload signature <<< "$token"
            if [ -z "$payload" ]; then
              echo "::warning title=$name invalid::Secret $name is not a JWT"
              return
            fi
            # Base64 decode payload (handle URL-safe base64)
            payload_b64=$(echo "$payload" | tr '_-' '/+')
            # Add padding if needed
            pad=$(( (4 - ${#payload_b64} % 4) % 4 ))
            if [ $pad -gt 0 ]; then payload_b64="${payload_b64}$(printf '=%.0s' $(seq 1 $pad))"; fi
            exp=$(echo "$payload_b64" | base64 -d 2>/dev/null | jq -r '.exp // empty')
            if [ -z "$exp" ] || [ "$exp" = "null" ]; then
              echo "::group::${name} details"
              echo "Secret $name has no exp claim; rotation cannot be checked automatically."
              echo "::endgroup::"
              return
            fi
            now=$(date +%s)
            seconds_left=$(( exp - now ))
            days_left=$(( seconds_left / 86400 ))
            if [ $days_left -lt $threshold_days ]; then
              echo "::error title=$name expires soon::$name expires in ${days_left} days"
              echo "${name} expires at: $(date -u -d @${exp})" >> "$GITHUB_STEP_SUMMARY"
              exit 1
            else
              echo "::notice title=$name ok::$name valid, ${days_left} days until expiration"
              echo "${name} valid, ${days_left} days until expiration" >> "$GITHUB_STEP_SUMMARY"
            fi
          }

          sudo apt-get update && sudo apt-get install -y jq >/dev/null 2>&1
          # Threshold: 14 days
          check_token "SUPABASE_SERVICE_ROLE_KEY" "$SUPABASE_SERVICE_ROLE_KEY" 14
          check_token "NEXT_PUBLIC_SUPABASE_ANON_KEY" "$NEXT_PUBLIC_SUPABASE_ANON_KEY" 14

